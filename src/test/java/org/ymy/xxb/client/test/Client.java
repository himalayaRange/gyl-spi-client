package org.ymy.xxb.client.test;

import java.io.UnsupportedEncodingException;
import java.util.HashMap;
import java.util.Map;
import org.apache.commons.codec.binary.Base64;
import org.junit.Assert;
import org.junit.Test;
import org.ymy.xxb.client.factory.SpiClient;
import org.ymy.xxb.client.factory.YmySpiClientFactory;
import com.alibaba.fastjson.JSON;
public class Client {
	private static final String ACCOUNT = "wangyi";
	
	private static final String PASSWORD = "10000";

	/**
	 * 1.获取平台AccessToken,商户获取accessToken，需要缓存在本地，请求接口时通过缓存获取
	 * 2.目前accessToken有效时间为30分钟，商户需要项目中通过定时任务或线程维护accessToken
	 * 3.Client -> 中间件（AccessToken）
	 * @throws IllegalAccessException 
	 * @throws InstantiationException 
	 * @throws UnsupportedEncodingException 
	 */
	@Test
	@SuppressWarnings("unchecked")
	public void getAccessToken() throws InstantiationException, IllegalAccessException, UnsupportedEncodingException {
		long start = System.currentTimeMillis();
		String getAccessTokenURL = "http://localhost:11000/passport/platform/getAccessToken";
		YmySpiClientFactory factory = YmySpiClientFactory.class.newInstance();
		Map<String, Object> accountInfo = new HashMap<String,Object>();
		accountInfo.put("account", ACCOUNT);
		accountInfo.put("password", Base64.encodeBase64String(PASSWORD.getBytes("UTF-8")));
		SpiClient spiClient = factory.configuration(getAccessTokenURL, accountInfo, null);
		String resultJson = spiClient.execute();
		Map<String,Object> parseObject = JSON.parseObject(resultJson , Map.class);
		boolean success = (boolean)parseObject.get("success");
		long end = System.currentTimeMillis();
		System.out.println("耗时：" + (end - start) + "ms");
		if(success) {
			Object dataObject = parseObject.get("data");
			if(dataObject != null) {
				String accessToken = dataObject.toString();
				Assert.assertNotNull(accessToken);
				System.out.println(accessToken);
			} else {
				System.out.println(parseObject.get("message"));
			}
		} else {
			System.out.println(parseObject.get("message"));
		}
	}
	
	/**
	 * 获取中台Token
	 * Client -> 中间件 -> E3(AccessToken)
	 * @throws IllegalAccessException 
	 * @throws InstantiationException 
	 */
	@Test
	@SuppressWarnings("unchecked")
	public void getE3AccessToken() throws InstantiationException, IllegalAccessException {
		String accessToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0eXBlIjoiYmVhcmVyIiwiaWF0IjoxNTQ3MTA5MjIxLCJzdWIiOiJ7XCJyb2xlSWRcIjpcIjFcIixcInJvbGVOYW1lXCI6XCJzdXBBZG1pblwiLFwiYXR0cmlidXRlc1wiOnt9LFwidXNlck5hbWVcIjpcInlteS54eGIuZGV2bG9wZXJcIixcInVzZXJJZFwiOlwiMVwifSIsImlzcyI6IjE2MTA2NTE3MTdAcXEuY29tIiwiYXVkIjoiUkVTVEFQSUBzdXBBZG1pbiIsImV4cCI6MTU0NzExMTAyMSwibmJmIjoxNTQ3MTA5MjIxfQ.bBUS4WX3cb1jgOkC297gxQ8ePLozOQ2uTkkv6uREj0E";
		String getE3AccessTokenURL = "http://localhost:11000/spi/e3/completionOrder/push/getAccessToken";
		YmySpiClientFactory factory = YmySpiClientFactory.class.newInstance();
		SpiClient spiClient = factory.configuration(getE3AccessTokenURL, null, accessToken);
		String resultJson = spiClient.execute();
		Map<String,Object> parseObject = JSON.parseObject(resultJson , Map.class);
		boolean success = (boolean)parseObject.get("success");
		if(success) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
			Object dataObject = parseObject.get("data");
			if(dataObject != null) {
				String e3AccessTokenData = dataObject.toString();
				Assert.assertNotNull(e3AccessTokenData);
			} else{
				System.out.println(parseObject.get("message"));
			}
		}
	}
}
